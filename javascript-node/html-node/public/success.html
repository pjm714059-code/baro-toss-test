<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>결제 완료 | 바로정산</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; padding: 24px; }
      .box { max-width: 720px; margin: 0 auto; border: 1px solid #ddd; border-radius: 12px; padding: 18px; }
      .muted { color: #666; font-size: 13px; }
      pre { background: #111; color: #eee; padding: 12px; border-radius: 10px; overflow: auto; }
      .ok { color: #0a7; font-weight: 700; }
      .bad { color: #d00; font-weight: 700; }
      a { color: #06c; }
    </style>
  </head>
  <body>
    <div class="box">
      <h2>결제 처리 중...</h2>
      <div class="muted" id="info"></div>
      <div id="status" class="muted" style="margin-top:10px;"></div>
      <pre id="result" style="display:none;"></pre>
      <div style="margin-top:14px;">
        <a href="/">결제 페이지로 돌아가기</a>
      </div>
    </div>

    <script>
      (async function () {
        const params = new URLSearchParams(window.location.search);
        const paymentKey = params.get("paymentKey");
        const orderId = params.get("orderId");
        const amount = params.get("amount");

        const info = document.getElementById("info");
        const status = document.getElementById("status");
        const result = document.getElementById("result");

        info.textContent = `orderId=${orderId || "-"} / amount=${amount || "-"}`;

        if (!paymentKey || !orderId || !amount) {
          status.innerHTML = `<span class="bad">필수 값이 누락되었습니다.</span> (paymentKey/orderId/amount)`;
          return;
        }

        try {
          status.textContent = "결제 승인 요청 중...";
          const res = await fetch("/confirm", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              paymentKey,
              orderId,
              amount: parseInt(amount, 10),
            }),
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok || !data.ok) {
            status.innerHTML = `<span class="bad">결제 승인 실패</span>`;
            result.style.display = "block";
            result.textContent = JSON.stringify(data, null, 2);
            return;
          }

          status.innerHTML = `<span class="ok">결제 승인 완료</span>`;
          result.style.display = "block";
          result.textContent = JSON.stringify(data.toss || data, null, 2);
        } catch (e) {
          status.innerHTML = `<span class="bad">오류 발생</span> ${e && e.message ? e.message : ""}`;
        }
      })();
    </script>
  </body>
</html>
