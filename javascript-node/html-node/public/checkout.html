<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="https://static.toss.im/icons/png/4x/icon-toss-logo.png" />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>바로정산 결제</title>
    <script src="https://js.tosspayments.com/v2/standard"></script>
  </head>

  <body>
    <div class="wrapper">
      <div class="box_section" style="padding: 40px 30px 50px 30px; margin-top: 30px; margin-bottom: 18px">
        <div style="padding-left: 4px; margin-bottom: 16px">
          <div class="typography--p typography--regular">
            <strong>서비스명:</strong> <span id="ordername-text">바로정산 정산대행 서비스</span>
          </div>

          <!-- 금액 입력 -->
          <div style="margin-top: 12px">
            <div class="typography--p typography--regular" style="margin-bottom: 6px">
              <strong>정산대행신청금액</strong> (원)
            </div>
            <input
              id="base-amount-input"
              inputmode="numeric"
              placeholder="예: 500000"
              style="width: 100%; padding: 12px 14px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px"
              autocomplete="off"
            />
            <div style="margin-top: 6px; font-size: 12px; color: #666">
              최대 <strong>2,000,000원</strong>까지 입력 가능합니다.
            </div>
          </div>

          <!-- 자동 계산 표시 -->
          <div style="margin-top: 14px; padding: 12px 14px; background: #fafafa; border: 1px solid #eee; border-radius: 12px">
            <div class="typography--p typography--regular">
              <strong>약정서구매비용:</strong> <span id="fee-text">-</span>
            </div>
            <div class="typography--p typography--regular" style="margin-top: 6px">
              <strong>총 결제금액:</strong> <span id="total-text">-</span>
            </div>
          </div>

          <!-- 체크박스 -->
          <div style="margin-top: 14px; padding-left: 2px">
            <div class="checkable typography--p" style="margin-bottom: 8px">
              <label class="checkable__label typography--regular">
                <input id="check-amount" class="checkable__input" type="checkbox" />
                <span class="checkable__label-text">입력 금액 확인</span>
              </label>
            </div>

            <div class="checkable typography--p">
              <label class="checkable__label typography--regular">
                <input id="check-policy" class="checkable__input" type="checkbox" />
                <span class="checkable__label-text">서비스 제공 주기/환불 규정 확인</span>
              </label>
            </div>

            <div style="margin-top: 8px; font-size: 12px; color: #666; line-height: 1.5">
              서비스 제공 주기: <strong>결제 1회당 1회 제공</strong> (결제 확인 후 처리) <br />
              환불 규정: <strong>서비스 제공 완료 후 환불 불가</strong> (결제 오류 등 당사 귀책 시 내부 기준에 따라 처리)
            </div>
          </div>
        </div>

        <!-- 결제 UI -->
        <div id="payment-method"></div>
        <!-- 이용약관 UI -->
        <div id="agreement"></div>

        <!-- 결제하기 버튼 -->
        <div class="result wrapper">
          <button class="button" id="payment-button" style="margin-top: 22px" disabled>
            결제하기
          </button>
        </div>

        <div id="err" style="margin-top: 14px; font-size: 12px; color: #d00; display: none"></div>
      </div>

      <!-- 하단 사업자 정보 -->
      <div class="box_section" style="padding: 20px 30px; margin-bottom: 60px">
        <div style="font-size: 12px; line-height: 1.6; color: #666">
          <div style="font-weight: 700; margin-bottom: 8px">사업자 정보</div>
          <div>상호명: 바로정산</div>
          <div>대표자명: 박재민</div>
          <div>사업자등록번호: 457-70-00757</div>
          <div>사업장 주소: 경기도 의정부시 송양로 45 813동 4층</div>
          <div>고객센터 연락처: 010-6729-0417</div>
        </div>
      </div>
    </div>

    <script>
      main();

      async function main() {
        const orderName = "바로정산 정산대행 서비스";

        const input = document.getElementById("base-amount-input");
        const feeText = document.getElementById("fee-text");
        const totalText = document.getElementById("total-text");
        const btn = document.getElementById("payment-button");
        const errBox = document.getElementById("err");

        const chkAmount = document.getElementById("check-amount");
        const chkPolicy = document.getElementById("check-policy");

        const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm"; // TODO: 실운영 키로 교체
        const customerKey = generateRandomString();
        const tossPayments = TossPayments(clientKey);
        const widgets = tossPayments.widgets({ customerKey });

        let baseAmount = 0;
        let feeAmount = 0;
        let totalAmount = 0;

        await widgets.setAmount({ currency: "KRW", value: 0 });

        await widgets.renderPaymentMethods({
          selector: "#payment-method",
          variantKey: "DEFAULT",
        });

        await widgets.renderAgreement({ selector: "#agreement", variantKey: "AGREEMENT" });

        input.addEventListener("input", onAmountChanged);
        chkAmount.addEventListener("change", updateButtonState);
        chkPolicy.addEventListener("change", updateButtonState);

        btn.addEventListener("click", async function () {
          try {
            setError("");

            if (!isValidTotal(totalAmount)) throw new Error("결제 금액이 올바르지 않습니다.");
            if (!chkAmount.checked || !chkPolicy.checked) throw new Error("확인 항목을 체크해주세요.");

            btn.disabled = true;
            btn.textContent = "결제 준비중...";

            const created = await fetchJSON("/create-order", {
              amount: totalAmount,
              orderName: orderName,
            });

            if (!created.ok) throw new Error(created.message || "주문 생성 실패");

            btn.textContent = "결제창 여는 중...";

            await widgets.requestPayment({
              orderId: created.orderId,
              orderName: orderName,
              successUrl: window.location.origin + "/success.html",
              failUrl: window.location.origin + "/fail.html",
              customerEmail: "customer123@gmail.com",
              customerName: "고객",
              customerMobilePhone: "01012341234",
            });
          } catch (e) {
            setError(e && e.message ? e.message : "결제 요청 중 오류가 발생했습니다.");
            btn.disabled = false;
            btn.textContent = "결제하기";
            updateButtonState();
          }
        });

        function onAmountChanged() {
          const raw = String(input.value || "").replace(/[^\d]/g, "");
          input.value = raw ? new Intl.NumberFormat("ko-KR").format(parseInt(raw, 10)) : "";

          const n = raw ? parseInt(raw, 10) : 0;
          baseAmount = Number.isFinite(n) ? n : 0;

          // 입력 최대 2,000,000원
          if (baseAmount > 2000000) baseAmount = 2000000;

          // 약정서구매비용 15% (원 단위 절사)
          feeAmount = Math.floor(baseAmount * 0.15);
          totalAmount = baseAmount + feeAmount;

          feeText.textContent = baseAmount > 0 ? formatKRW(feeAmount) : "-";
          totalText.textContent = baseAmount > 0 ? formatKRW(totalAmount) : "-";

          updateWidgetAmount(totalAmount);
          updateButtonState();
        }

        let lastSetValue = null;
        async function updateWidgetAmount(v) {
          try {
            if (lastSetValue === v) return;
            lastSetValue = v;
            await widgets.setAmount({ currency: "KRW", value: v });
          } catch (e) {
            console.log("setAmount failed:", e);
          }
        }

        function updateButtonState() {
          const okAmount = isValidTotal(totalAmount);
          const okChecks = chkAmount.checked && chkPolicy.checked;

          btn.disabled = !(okAmount && okChecks);
          if (!btn.disabled) btn.textContent = "결제하기";
        }

        function isValidTotal(v) {
          if (!Number.isFinite(v)) return false;
          if (v <= 0) return false;
          // 총액 최대: 2,300,000원
          if (v > 2300000) return false;
          return true;
        }

        function setError(msg) {
          if (!msg) {
            errBox.style.display = "none";
            errBox.textContent = "";
            return;
          }
          errBox.style.display = "block";
          errBox.textContent = msg;
        }
      }

      function generateRandomString() {
        return window.btoa(Math.random()).slice(0, 20);
      }

      function formatKRW(value) {
        return new Intl.NumberFormat("ko-KR").format(value) + "원";
      }

      async function fetchJSON(url, body) {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body || {}),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const msg = data && (data.message || (data.toss && data.toss.message));
          throw new Error(msg || `HTTP ${res.status}`);
        }
        return data;
      }
    </script>
  </body>
</html>
