<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="https://static.toss.im/icons/png/4x/icon-toss-logo.png" />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>바로정산 결제</title>
    <script src="https://js.tosspayments.com/v2/standard"></script>
  </head>

  <body>
    <div class="wrapper">
      <div class="box_section" style="padding: 40px 30px 50px 30px; margin-top: 30px; margin-bottom: 18px">
        <div style="padding-left: 4px; margin-bottom: 14px">
          <div class="typography--p typography--regular">
            <strong>서비스명:</strong> <span id="ordername-text">바로정산</span>
          </div>
          <div class="typography--p typography--regular" style="margin-top: 6px">
            <strong>결제 금액:</strong> <span id="amount-text">-</span>
          </div>
          <div class="typography--p typography--regular" style="margin-top: 6px; font-size: 12px; color: #666">
            결제 후 서비스 제공 완료 시 환불이 제한될 수 있습니다. 하단의 환불/취소 규정을 확인해주세요.
          </div>
        </div>

        <div id="payment-method"></div>
        <div id="agreement"></div>

        <div class="result wrapper">
          <button class="button" id="payment-button" style="margin-top: 30px">
            결제하기
          </button>
        </div>

        <div id="err" style="margin-top: 14px; font-size: 12px; color: #d00; display: none"></div>
      </div>

      <!-- ✅ 토스가 요구하는 "하단 사업자 정보" -->
      <div class="box_section" style="padding: 20px 30px; margin-bottom: 60px">
        <div style="font-size: 12px; line-height: 1.6; color: #666">
          <div style="font-weight: 700; margin-bottom: 8px">사업자 정보</div>
          <div>상호명: 바로정산</div>
          <div>대표자명: 박재민</div>
          <div>사업자등록번호: 457-70-00757</div>
          <div>사업장 주소: 경기도 의정부시 송양로45 4층</div>
          <div>고객센터 연락처: 010-6729-0417</div>
          <div style="margin-top: 8px; font-weight: 700">환불/취소 규정</div>
          <div style="margin-top: 4px">
            본 서비스는 결제 1회당 1회성 정산대행(사무대행) 서비스입니다. 서비스 제공 완료 이후에는 환불이 불가합니다.
            (단, 결제 오류 등 당사 귀책 사유 발생 시 내부 기준에 따라 처리됩니다.)
          </div>
        </div>
      </div>
    </div>

    <script>
      main();

      async function main() {
        const button = document.getElementById("payment-button");
        const amountText = document.getElementById("amount-text");
        const orderNameText = document.getElementById("ordername-text");
        const errBox = document.getElementById("err");

        // ✅ URL 파라미터로 금액을 바꿈 (카카오채널 건별 링크 생성용)
        // 예: https://.../?amount=187000&name=바로정산
        const params = new URLSearchParams(window.location.search);
        const amountParam = params.get("amount");
        const nameParam = params.get("name");

        const orderName = (nameParam && nameParam.trim()) ? nameParam.trim().slice(0, 40) : "바로정산";
        const amountValue = parseAmount(amountParam) ?? 50000; // 기본값(원하면 0으로 두고 필수입력으로 강제 가능)

        orderNameText.textContent = orderName;
        amountText.textContent = formatKRW(amountValue);

        // ------ 결제위젯 초기화 ------
        // TODO: 실운영은 개발자센터의 클라이언트 키로 교체
        const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm";
        const customerKey = generateRandomString();
        const tossPayments = TossPayments(clientKey);

        const widgets = tossPayments.widgets({ customerKey });

        // ------ 결제 금액 설정 ------
        await widgets.setAmount({ currency: "KRW", value: amountValue });

        // ------ 결제 UI 렌더링 ------
        await widgets.renderPaymentMethods({
          selector: "#payment-method",
          variantKey: "DEFAULT",
        });

        // ------ 이용약관 UI 렌더링 ------
        await widgets.renderAgreement({ selector: "#agreement", variantKey: "AGREEMENT" });

        // ------ 결제 요청 ------
        button.addEventListener("click", async function () {
          try {
            setError("");

            button.disabled = true;
            button.textContent = "결제 준비중...";

            // ✅ 서버에서 orderId 발급 (금액 조작 방지의 핵심)
            const created = await fetchJSON("/create-order", {
              amount: amountValue,
              orderName: orderName,
            });

            if (!created.ok) {
              throw new Error(created.message || "주문 생성 실패");
            }

            button.textContent = "결제창 여는 중...";

            await widgets.requestPayment({
              orderId: created.orderId,
              orderName: orderName,
              successUrl: window.location.origin + "/success.html",
              failUrl: window.location.origin + "/fail.html",
              customerEmail: "customer123@gmail.com",
              customerName: "고객",
              customerMobilePhone: "01012341234",
            });
          } catch (e) {
            setError(e && e.message ? e.message : "결제 요청 중 오류가 발생했습니다.");
            button.disabled = false;
            button.textContent = "결제하기";
          }
        });

        function setError(msg) {
          if (!msg) {
            errBox.style.display = "none";
            errBox.textContent = "";
            return;
          }
          errBox.style.display = "block";
          errBox.textContent = msg;
        }
      }

      function parseAmount(v) {
        if (!v) return null;
        // 숫자만 추출 (예: "187,000"도 허용)
        const digits = String(v).replace(/[^\d]/g, "");
        if (!digits) return null;
        const n = parseInt(digits, 10);
        if (!Number.isFinite(n) || n <= 0) return null;
        return n;
      }

      function generateRandomString() {
        return window.btoa(Math.random()).slice(0, 20);
      }

      function formatKRW(value) {
        try {
          return new Intl.NumberFormat("ko-KR").format(value) + "원";
        } catch (e) {
          return String(value) + "원";
        }
      }

      async function fetchJSON(url, body) {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body || {}),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          // 서버가 toss 스타일 에러를 주는 경우까지 대비
          const msg = data && (data.message || (data.toss && data.toss.message));
          throw new Error(msg || `HTTP ${res.status}`);
        }
        return data;
      }
    </script>
  </body>
</html>
